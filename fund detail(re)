# TEMU å¹³å°èµ„é‡‘æ˜ç»†è‡ªåŠ¨åˆå¹¶è„šæœ¬ï¼ˆé€‚ç”¨äº Jupyter Notebookï¼‰

import pandas as pd
import numpy as np
from collections import defaultdict

# è·¯å¾„é…ç½®

excel_path = "hl FundDetail6.9-6.15.xlsx"

# è¯»å–æ‰€æœ‰ sheet
all_sheets = pd.read_excel(excel_path, sheet_name=None)

# åˆå§‹åŒ–ç»“æœè¡¨å’Œå„ç±»å‹åç§°
sheet_map = {
    "äº¤æ˜“æ”¶å…¥": None,
    "è¿è´¹æ”¶å…¥": None,
    "å”®åé€€æ¬¾": None,
    "è¿è´¹é€€æ¬¾": None,
}

# å®šä¹‰å…³é”®å­—æŸ¥æ‰¾å®šä½ sheet
for sheet_name, df in all_sheets.items():
    if "äº¤æ˜“æ”¶å…¥" in sheet_name:
        sheet_map["äº¤æ˜“æ”¶å…¥"] = df[['è®¢å•ç¼–å·', 'äº¤æ˜“æ”¶å…¥']]
    elif "è¿è´¹æ”¶å…¥" in sheet_name:
        sheet_map["è¿è´¹æ”¶å…¥"] = df[['è®¢å•ç¼–å·', 'è¿è´¹æ”¶å…¥']]
    elif "å”®åé€€æ¬¾" in sheet_name:
        sheet_map["å”®åé€€æ¬¾"] = df[['è®¢å•ç¼–å·', 'å”®åé€€æ¬¾é‡‘é¢']]
    elif "è¿è´¹é€€æ¬¾" in sheet_name:
        sheet_map["è¿è´¹é€€æ¬¾"] = df[['è®¢å•ç¼–å·', 'è¿è´¹é€€æ¬¾']]

# å…¨éƒ¨è¡¨æ ¼çš„è®¢å•ç¼–å·åŠ åºå·ï¼Œå¤„ç†é‡å¤
renamed = {}
for key, df in sheet_map.items():
    if df is not None:
        df = df.copy()
        df['è®¢å•ç¼–å·'] = df['è®¢å•ç¼–å·'].astype(str)
        df['_seq'] = df.groupby('è®¢å•ç¼–å·').cumcount() + 1
        df['è®¢å•ç¼–å·_åºå·'] = df['è®¢å•ç¼–å·'] + '_' + df['_seq'].astype(str)
        renamed[key] = df.drop(columns=['_seq'])

# ä»¥äº¤æ˜“æ”¶å…¥ä¸ºä¸»è¡¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºè¡¨
main_df = renamed.get("äº¤æ˜“æ”¶å…¥", pd.DataFrame(columns=['è®¢å•ç¼–å·', 'äº¤æ˜“æ”¶å…¥', 'è®¢å•ç¼–å·_åºå·']))

# åŒæ­¥èåˆå…¶ä»–åˆ—
for key in ["è¿è´¹æ”¶å…¥", "å”®åé€€æ¬¾", "è¿è´¹é€€æ¬¾"]:
    df = renamed.get(key)
    if df is not None:
        main_df = pd.merge(main_df, df.drop(columns=['è®¢å•ç¼–å·']), on='è®¢å•ç¼–å·_åºå·', how='outer')

# ç®—å‡ºå¹³å°å›æ¬¾
main_df[['äº¤æ˜“æ”¶å…¥', 'è¿è´¹æ”¶å…¥', 'å”®åé€€æ¬¾é‡‘é¢', 'è¿è´¹é€€æ¬¾']] = main_df[[
    'äº¤æ˜“æ”¶å…¥', 'è¿è´¹æ”¶å…¥', 'å”®åé€€æ¬¾é‡‘é¢', 'è¿è´¹é€€æ¬¾']].fillna(0)
main_df['å¹³å°å›æ¬¾'] = main_df['äº¤æ˜“æ”¶å…¥'] + main_df['è¿è´¹æ”¶å…¥'] - main_df['å”®åé€€æ¬¾é‡‘é¢'] - main_df['è¿è´¹é€€æ¬¾']

# æŒ‰éœ€æ’åˆ—ï¼ˆå¯é€‰ï¼‰
main_df = main_df.sort_values(by='è®¢å•ç¼–å·')


# è‹¥åŸå§‹è®¢å•ç¼–å·ä¸ºç©ºï¼Œæ ¹æ®â€œè®¢å•ç¼–å·_åºå·â€æå–å›åŸå§‹è®¢å•ç¼–å·
main_df['è®¢å•ç¼–å·'] = main_df.apply(
    lambda row: row['è®¢å•ç¼–å·'] if pd.notnull(row['è®¢å•ç¼–å·']) else row['è®¢å•ç¼–å·_åºå·'].rsplit('_', 1)[0],
    axis=1
)


# è¾“å‡º
main_df.to_excel("hl FundDetail6.9-6.15.xlsx_æ±‡æ€»ç»“æœ.xlsx", index=False)
print("âœ… æ±‡æ€»å®Œæˆï¼Œå·²å¯¼å‡ºä¸º Excel æ–‡ä»¶ã€‚")







# è‡ªåŠ¨æå–â€œç¾ä¸œ/ç¾è¥¿â€å‡ºåº“æ˜ç»†ä¸‰åˆ—å¹¶åˆå¹¶å¯¼å‡ºï¼ˆé€‚é…æ¢è¡Œåˆ—åï¼Œå¢å¼ºç¾è¥¿å…¼å®¹æ€§ï¼‰


folder_path = 'hl outbound'  # ä¿®æ”¹ä¸ºä½ çš„å®é™…æ–‡ä»¶å¤¹è·¯å¾„
all_files = glob.glob(os.path.join(folder_path, '*.xlsx'))

merged_list = []

for file in all_files:
    filename = os.path.basename(file)
    df = pd.read_excel(file, sheet_name=0)

    # æ¸…æ´—åˆ—åï¼šå»é™¤æ¢è¡Œå’Œå¤šä½™ç©ºæ ¼
    df.columns = [str(col).replace('\n', '').replace('\r', '').strip() for col in df.columns]

    # é»˜è®¤è®¾ä¸ºç©º
    order_col, sku_col, qty_col = None, None, None

    if 'ç¾è¥¿' in filename:
        order_col = next((col for col in df.columns if 'Platform order No' in col and 'å•å·' in col), None)
        sku_col = next((col for col in df.columns if 'SKU1' in col and 'SKU 1' in col), None)
        qty_col = next((col for col in df.columns if 'SKU 1' in col and ('å‡ºåº“æ•°é‡' in col or 'Outbound Qty' in col)), None)

    elif 'ç¾ä¸œ' in filename:
        order_col = next((col for col in df.columns if 'Platform order No' in col and 'å•å·' in col), None)
        sku_col = next((col for col in df.columns if 'SKU1' in col and 'SKU 1' in col), None)
        qty_col = next((col for col in df.columns if 'SKU 1' in col and ('å‡ºåº“æ•°é‡' in col or 'Outbound Qty' in col)), None)

    else:
        print(f"âš ï¸ æœªè¯†åˆ«åŒºåŸŸï¼š{filename}ï¼Œè·³è¿‡")
        continue

    print(f"\nğŸ“„ æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼š{filename}")
    print(f"â†’ åŒ¹é…åˆ—åï¼šè®¢å•={order_col}, SKU={sku_col}, å‡ºåº“æ•°é‡={qty_col}")

    if order_col and sku_col and qty_col:
        temp = df[[order_col, sku_col, qty_col]].copy()
        temp.columns = ['è®¢å•å·', 'SKU', 'å‡ºåº“æ•°é‡']
        temp['æ¥æºæ–‡ä»¶'] = filename
        merged_list.append(temp)
    else:
        print(f"âŒ ç¼ºå°‘å¿…è¦åˆ—ï¼Œè·³è¿‡æ–‡ä»¶ï¼š{filename}")
        print("ğŸ“‹ å½“å‰åˆ—åä¸ºï¼š", df.columns.tolist())

# åˆå¹¶ & å¯¼å‡º
if merged_list:
    result = pd.concat(merged_list, ignore_index=True)
    result.to_excel('hl outbound åˆå¹¶æ±‡æ€».xlsx', index=False)
    print("\nâœ… æ‰€æœ‰æœ‰æ•ˆæ–‡ä»¶å·²åˆå¹¶å¯¼å‡ºä¸º hl outbound åˆå¹¶æ±‡æ€».xlsx")
else:
    print("\nâš ï¸ æ²¡æœ‰æœ‰æ•ˆæ•°æ®è¢«åˆå¹¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åˆ—åæ˜¯å¦ä¸€è‡´ã€‚")











import pandas as pd

# ====== ç¬¬äºŒæ­¥ï¼šå°†å‡ºåº“ä¿¡æ¯åŒ¹é…åˆ°èµ„é‡‘æ±‡æ€»è¡¨ä¸­ ======

# è¯»å–èµ„é‡‘æ±‡æ€»è¡¨
fund_df = pd.read_excel('hl FundDetail6.9-6.15.xlsx_æ±‡æ€»ç»“æœ.xlsx')

# è¯»å–å‡ºåº“ä¿¡æ¯è¡¨ï¼ˆä¹‹å‰å¯¼å‡ºçš„ï¼‰
outbound_df = pd.read_excel('hl outbound åˆå¹¶æ±‡æ€».xlsx')

# å»é™¤ outbound_df ä¸­é‡å¤è®¢å•å·ï¼Œä»…ä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°çš„è®°å½•
outbound_unique = outbound_df.drop_duplicates(subset='è®¢å•å·')

# åˆå¹¶ï¼šå·¦è¿æ¥ï¼Œä»¥è®¢å•å·ä¸ºé”®
merged_df = pd.merge(
    fund_df,
    outbound_unique[['è®¢å•å·', 'SKU', 'å‡ºåº“æ•°é‡']],
    how='left',
    left_on='è®¢å•ç¼–å·',
    right_on='è®¢å•å·'
)

# åˆ é™¤å³ä¾§é‡å¤çš„è®¢å•å·åˆ—
merged_df.drop(columns=['è®¢å•å·'], inplace=True)

# âœ… é‡æ–°å®‰æ’åˆ—é¡ºåºï¼šè®¢å•ç¼–å· â†’ SKU â†’ å‡ºåº“æ•°é‡ â†’ å…¶ä»–åˆ—
prefix_cols = ['è®¢å•ç¼–å·', 'SKU', 'å‡ºåº“æ•°é‡']
other_cols = [col for col in merged_df.columns if col not in prefix_cols]
merged_df = merged_df[prefix_cols + other_cols]

# å¯¼å‡ºæœ€ç»ˆæ–‡ä»¶
merged_df.to_excel('hl FundDetail_æ±‡æ€»_å«å‡ºåº“ä¿¡æ¯.xlsx', index=False)
print("âœ… å·²åŒ¹é…å‡ºåº“ä¿¡æ¯å¹¶å¯¼å‡º hl FundDetail_æ±‡æ€»_å«å‡ºåº“ä¿¡æ¯.xlsx")
